<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Historical Disaster Reports</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
body { font-family: 'Poppins', sans-serif; background: radial-gradient(circle at top, #1a2b4f, #060b18 70%); color:#e6e6e6; padding:35px;}
#backBtn { border-radius:12px; padding:10px 18px; font-weight:600; font-size:15px; background: linear-gradient(135deg,#2b65ff,#1a45d8)!important; border:none; color:#fff!important; display:inline-flex; align-items:center; gap:8px; box-shadow:0 0 15px rgba(50,120,255,0.6);}
#backBtn:hover { background:linear-gradient(135deg,#4b7bff,#2d55ff)!important; transform:translateY(-3px); box-shadow:0 0 18px rgba(90,140,255,0.9);}
.glass-card {backdrop-filter: blur(22px) saturate(200%); background: rgba(255,255,255,0.10); border-radius:18px; border:1.5px solid rgba(255,255,255,0.28); padding:26px; margin-bottom:25px; box-shadow:0 12px 30px rgba(0,0,0,0.45);}
h2 { text-align:center; font-weight:800; margin-bottom:25px; color:#fff; letter-spacing:1.5px;}
.center-heading { text-align:center; width:100%; margin-bottom:18px; font-size:22px;}
.form-control,.form-select { background: rgba(255,255,255,0.18)!important; color:#fff!important; border:1px solid rgba(255,255,255,0.45)!important; font-weight:600;}
.form-select option { color:#000;}
.btn-custom { padding:10px 16px; border-radius:12px; font-weight:500; transition:0.2s ease;}
.btn-custom:hover { transform:translateY(-3px); box-shadow:0 0 12px rgba(255,255,255,0.35);}
.save-btn-fixed { width:220px; margin:auto; display:block;}
.btn-delete { background:#c40000!important; border:2px solid #ff0000!important; color:#fff!important; font-size:14px; padding:7px 14px; border-radius:8px; box-shadow:0 0 12px rgba(255,0,0,0.8); transition:0.2s;}
.btn-delete:hover { background:#ff0000!important; border-color:#ff4d4d!important; transform:scale(1.12); box-shadow:0 0 18px rgba(255,60,60,1);}
table { color:#fff; border-radius:12px; overflow:hidden!important;}
thead tr { text-align:center; background: rgba(255,255,255,0.25);}
tbody tr { text-align:center; background: rgba(255,255,255,0.12); transition:all 0.25s;}
tbody tr:hover { background: rgba(255,255,255,0.25); transform:scale(1.005);}
#addReportForm { display:none;}
</style>
</head>
<body>

<a href="/admin/dashboard" id="backBtn"><i class="fa-solid fa-arrow-left"></i> Back</a>
<h2>ðŸ“„ Historical Disaster Reports</h2>

<div class="glass-card">
  <div class="row g-3 align-items-end">
    <div class="col-md-4">
      <label class="form-label fw-semibold">Select Report Type</label>
      <select id="reportType" class="form-select">
        <option value="all">All</option>
        <option value="earthquake">Earthquake</option>
        <option value="flood">Flood</option>
      </select>
    </div>
    <div class="col-md-8 d-flex flex-wrap gap-2 align-items-end">
      <button class="btn btn-success btn-custom" id="downloadExcel"><i class="fa-solid fa-file-excel"></i> Download Excel</button>
      <button class="btn btn-danger btn-custom" id="downloadPDF"><i class="fa-solid fa-file-pdf"></i> Download PDF</button>
      <button class="btn btn-primary btn-custom" id="addReportBtn"><i class="fa-solid fa-plus"></i> Add Report</button>
    </div>
  </div>
</div>

<div class="glass-card" id="addReportForm">
  <h4 class="fw-bold mb-3 center-heading">âž• Add New Report</h4>
  <div class="row g-3">
    <div class="col-md-3">
      <label class="form-label">Type</label>
      <select id="newType" class="form-select">
        <option value="Earthquake">Earthquake</option>
        <option value="Flood">Flood</option>
      </select>
    </div>
    <div class="col-md-3"><label>Date</label><input type="date" id="newDate" class="form-control"></div>
    <div class="col-md-3"><label>Area</label><input type="text" id="newArea" class="form-control" placeholder="Enter area"></div>
    <div class="col-md-3"><label>Latitude</label><input type="number" id="newLatitude" step="any" class="form-control"></div>
    <div class="col-md-3"><label>Longitude</label><input type="number" id="newLongitude" step="any" class="form-control"></div>
    <div class="col-md-3"><label>Severity</label>
<select id="newSeverity" class="form-select">
    <option value="" disabled selected>Select Severity</option>
    <option value="Minor">Minor</option>
    <option value="Low">Low</option>
    <option value="Moderate">Moderate</option>
    <option value="High">High</option>
    <option value="Severe">Severe</option>
</select>
</div>
    <div class="col-md-6"><label>Description</label><input type="text" id="newDescription" class="form-control" placeholder="Description"></div>
    <div class="col-12 mt-2 text-center"><button class="btn btn-success btn-custom save-btn-fixed" id="saveReport">Save Report</button></div>
  </div>
</div>

<div class="glass-card">
  <h4 class="fw-bold center-heading">ðŸ“Š Preview Data</h4>
  <table class="table table-bordered table-striped mt-2" id="reportTable">
    <thead>
      <tr><th>Type</th><th>Date</th><th>Area</th><th>Latitude</th><th>Longitude</th><th>Severity</th><th>Description</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
let fullData = [];
const addReportForm = document.getElementById('addReportForm');
const newSeverity = document.getElementById('newSeverity');

function setSeverityValue(severity) {
    let found = false;
    for (let i = 0; i < newSeverity.options.length; i++) {
        if (newSeverity.options[i].value === severity) {
            newSeverity.selectedIndex = i;
            found = true;
            break;
        }
    }
    if (!found) newSeverity.value = "";
}

async function loadHistoricData() {
    const res = await fetch("/api/historic_data");
    fullData = await res.json();
    const selected = reportType.value;
    renderTable(selected === "all" ? fullData : fullData.filter(i => i.type.toLowerCase() === selected));
}

function renderTable(data) {
    const tbody = document.querySelector("#reportTable tbody");
    tbody.innerHTML = "";
    data.forEach(row => {
        const tr = document.createElement("tr");
        const safeRow = encodeURIComponent(JSON.stringify(row));
        tr.innerHTML = `<td>${row.type}</td>
                        <td>${row.date}</td>
                        <td>${row.area}</td>
                        <td>${row.latitude}</td>
                        <td>${row.longitude}</td>
                        <td>${row.severity}</td>
                        <td>${row.description}</td>
                        <td><button class="btn-delete" onclick="deleteReport('${safeRow}')"><i class="fa-solid fa-trash"></i></button></td>`;
        tbody.appendChild(tr);
    });
}

// ----------------- DOWNLOAD EXCEL & PDF -----------------
document.getElementById("downloadExcel").addEventListener("click", () => {
    const type = document.getElementById("reportType").value;
    window.location.href = `/api/generate_report/excel/${type}`;
});

document.getElementById("downloadPDF").addEventListener("click", () => {
    const type = document.getElementById("reportType").value;
    window.location.href = `/api/generate_report/pdf/${type}`;
});

// ----------------- ADD / SAVE REPORT -----------------
addReportBtn.addEventListener("click", () => {
    addReportForm.style.display = addReportForm.style.display === "block" ? "none" : "block";
    if (addReportForm.style.display === "block") {
        newType.value = "Earthquake"; newDate.value = ""; newArea.value = "";
        newLatitude.value = ""; newLongitude.value = ""; setSeverityValue(""); newDescription.value = "";
        addReportForm.scrollIntoView({ behavior: "smooth" });
    }
});

saveReport.addEventListener("click", async () => {
    const newReport = {
        type: newType.value.toLowerCase(),
        date: newDate.value, area: newArea.value,
        latitude: newLatitude.value, longitude: newLongitude.value,
        magnitude: null, depth: null,
        severity: newSeverity.value,
        description: newDescription.value
    };
    if (!newReport.date || !newReport.area) return alert("Date and Area required!");
    if (!newReport.severity) return alert("Select severity!");
    const res = await fetch("/api/add_report", {
        method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(newReport)
    });
    if (res.ok) { alert("Report added!"); loadHistoricData(); addReportForm.style.display="none"; }
});

// ----------------- DELETE REPORT -----------------
async function deleteReport(encoded) {
    if (!confirm("Delete this report?")) return;
    const row = JSON.parse(decodeURIComponent(encoded));
    const res = await fetch("/api/delete_report", { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(row)});
    if (res.ok) { alert("Report Deleted Successfully!"); loadHistoricData(); }
}

reportType.addEventListener("change", loadHistoricData);
loadHistoricData();
</script>

</body>
</html>
