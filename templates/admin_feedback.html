<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin â€“ Feedback Management</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
body{
    background: radial-gradient(circle at top, #1a2b4f, #060b18 80%);
    color:#fff;
    padding:40px;
    font-family:Poppins,sans-serif;
}
h2{font-weight:800;margin-bottom:30px}
.card-glass{
    backdrop-filter: blur(18px);
    background: rgba(255,255,255,0.08);
    border:1px solid rgba(255,255,255,0.25);
    border-radius:18px;
    padding:25px;
}
.table{color:#fff}
thead{background:rgba(255,255,255,0.15)}
tbody tr{background:rgba(255,255,255,0.08)}
.reply-box{
    background:rgba(255,255,255,0.15);
    padding:8px 12px;
    border-radius:8px;
    margin-top:6px;
}
textarea{
    background:rgba(255,255,255,0.15)!important;
    color:#fff!important;
}
.user-info{
    display:flex;
    align-items:center;
    gap:10px;
}
.user-info img{
    width:35px;
    height:35px;
    border-radius:50%;
    object-fit:cover;
    border:1px solid rgba(255,255,255,0.4);
}
.user-details small{
    display:block;
    color:#ccc;
}
</style>
</head>

<body>

<a href="/admin/dashboard" class="btn btn-secondary mb-4">
<i class="fa fa-arrow-left"></i> Back
</a>

<h2>Admin Feedback & Issues</h2>

<div class="card-glass">
<table class="table table-bordered align-middle">
<thead>
<tr>
    <th>ID</th>
    <th>Disaster</th>
    <th>Type</th>
    <th>User</th>
    <th>Message</th>
    <th>Admin Reply</th>
    <th>Action</th>
</tr>
</thead>
<tbody id="feedbackTable"></tbody>
</table>
</div>

<!-- Reply Modal -->
<div class="modal fade" id="replyModal">
<div class="modal-dialog">
<div class="modal-content bg-dark text-white">
<div class="modal-header">
<h5 class="modal-title">Reply to Feedback</h5>
<button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<p id="feedbackText"></p>
<textarea id="replyMessage" class="form-control" rows="3" placeholder="Type reply..."></textarea>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
<button class="btn btn-primary" onclick="sendReply()">Send Reply</button>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
let currentId = null;

/* ============================
   MASK MOBILE
============================ */
function maskMobile(mobile){
    if(!mobile || mobile.length < 4) return "-";
    return mobile.slice(0,2) + "XXXXXX" + mobile.slice(-2);
}

/* ============================
   LOAD ADMIN FEEDBACK  âœ… FIXED
============================ */
async function loadFeedback(){
    const res = await fetch("/api/admin/feedback"); // ðŸ”¥ ADMIN API
    const data = await res.json();

    const table = document.getElementById("feedbackTable");
    table.innerHTML = "";

    if(!data.length){
        table.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-warning">
                    No feedback found
                </td>
            </tr>`;
        return;
    }

    data.forEach(f=>{
        /* ---------- Replies ---------- */
 /* ---------- Replies ---------- */
let replies = "";
if(f.replies && f.replies.length){
    f.replies.forEach(r=>{
        replies += `
            <div class="reply-box">
                <b>${r.admin_username || "Admin"}:</b> ${r.message}
                <br><small>${r.date}</small>
            </div>
        `;
    });
} else {
    replies = `<span class="text-warning">No reply yet</span>`;
}


        /* ---------- User ---------- */
        const user = f.user || {};
        const avatarHtml = user.avatar
            ? `<img src="/static/uploads/avatars/${user.avatar}" alt="avatar">`
            : "";

        const userHtml = `
            <div class="user-info">
                ${avatarHtml}
                <div class="user-details">
                    <b>${user.name || "Unknown"}</b>
                    <small>${user.email || "-"}</small>
                    <small>${maskMobile(user.mobile)}</small>
                </div>
            </div>
        `;

        /* ---------- Row ---------- */
        table.innerHTML += `
        <tr>
            <td>${f.id}</td>
            <td>${f.disaster_type}</td>
            <td>${f.type}</td>
            <td>${userHtml}</td>
            <td>${f.message}</td>
            <td>${replies}</td>
            <td>
                <button class="btn btn-sm btn-success"
                    onclick="openReply(${f.id}, '${encodeURIComponent(f.message)}')">
                    <i class="fa fa-reply"></i> Reply
                </button>
            </td>
        </tr>`;
    });
}

/* ============================
   OPEN REPLY MODAL
============================ */
function openReply(id,msg){
    currentId = id;
    document.getElementById("feedbackText").innerText = decodeURIComponent(msg);
    document.getElementById("replyMessage").value = "";
    new bootstrap.Modal(document.getElementById("replyModal")).show();
}

/* ============================
   SEND REPLY
============================ */
async function sendReply(){
    const reply = document.getElementById("replyMessage").value.trim();
    if(!reply){
        alert("Reply required");
        return;
    }

    const res = await fetch(`/api/feedback/reply/${currentId}`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({reply})
    });

    if(res.ok){
        bootstrap.Modal.getInstance(
            document.getElementById("replyModal")
        ).hide();

        loadFeedback();
        alert("Reply sent successfully");
    } else {
        alert("Reply failed");
    }
}

/* ============================
   INIT
============================ */
loadFeedback();
</script>

</body>
</html>
