<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üåßÔ∏è Flood Monitoring System</title>

<!-- Bootstrap & FontAwesome -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #0f172a, #1e293b, #0f2027);
    color: #fff;
    padding: 20px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
}

h2 {
    text-align: center;
    margin-bottom: 20px;
    font-weight: 700;
    font-size: 2rem;
    color: #f8fafc;
}

.btn-back {
    display: inline-block;
    margin-bottom: 25px;
    background-color: #0d6efd;
    color: #fff;
    font-weight: 600;
    border-radius: 8px;
    padding: 8px 15px;
    text-decoration: none;
    text-align: center;
    transition: 0.3s;
}
.btn-back:hover {
    background-color: #0b5ed7;
    color: #fff;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

#map {
    width: 100%;
    max-width: 1200px;
    height: 500px;
    border-radius: 15px;
    margin-bottom: 35px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

.table-wrapper {
    width: 100%;
    max-width: 1200px;
    background: rgba(255,255,255,0.05);
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.4);
    margin-bottom: 50px;
    overflow-x: auto;
}

.table-wrapper h4 {
    font-weight: 600;
    margin-bottom: 20px;
}

table {
    width: 100%;
    border-collapse: collapse;
    color: #fff;
}

thead th {
    background: rgba(0,123,255,0.9);
    color: #fff;
    text-align: center;
    font-weight: 600;
    padding: 10px;
    border-radius: 5px;
}

tbody tr {
    background: rgba(255,255,255,0.05);
    transition: transform 0.3s, background 0.3s;
}

tbody tr:hover {
    background: rgba(0,123,255,0.2);
    transform: scale(1.02);
}

.blink {
    animation: blink 1s infinite;
}
@keyframes blink {
    0%, 100% { opacity:1; }
    50% { opacity:0.2; }
}

.btn-alert {
    font-size: 0.85rem;
    padding: 5px 10px;
    font-weight: 600;
    border-radius: 8px;
    transition: 0.3s;
}
.btn-alert:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
</style>
</head>

<body>

<h2>üåßÔ∏è Real-Time Flood Monitoring Dashboard</h2>

<a href="/admin/dashboard" class="btn-back"><i class="fa fa-arrow-left"></i> Back to Dashboard</a>

<div id="map"></div>

<div class="table-wrapper">
<h4 class="text-center">Registered Users Weather Live Data</h4>
<table class="table table-bordered table-striped table-hover text-center">
<thead>
<tr>
  <th>Name</th>
  <th>Latitude</th>
  <th>Longitude</th>
  <th>Temperature (¬∞C)</th>
  <th>Precipitation (mm)</th>
  <th>Weather</th>
  <th>Status</th>
  <th>Time</th>
  <th>Alert</th>
</tr>
</thead>
<tbody id="weatherTable"></tbody>
</table>
</div>

<script>
const apiKey = "fb116bebc392ccc8ab251927edcb55d6";

const map = L.map("map").setView([20.5937, 78.9629], 5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let markers = {};

async function loadUsers() {
    try {
        const req = await fetch("/api/get_users_locations");
        return await req.json();
    } catch (err) {
        console.error("Failed to load users:", err);
        return [];
    }
}

async function loadWeather() {
    const users = await loadUsers();
    const table = document.getElementById("weatherTable");
    table.innerHTML = "";

    // Remove old markers
    for (const key in markers) map.removeLayer(markers[key]);
    markers = {};

    for (let u of users) {
        const url = `https://api.openweathermap.org/data/2.5/weather?lat=${u.lat}&lon=${u.lon}&appid=${apiKey}&units=metric`;
        const res = await fetch(url);
        const data = await res.json();

        const temp = data.main.temp;
        const weather = data.weather[0].description;
        const precipitation = data.rain ? data.rain["1h"] || 0 : 0;
        const humidity = data.main.humidity || 0;
        const time = new Date().toLocaleTimeString();

        const status = precipitation > 20 ? "High Risk" :
                       precipitation > 5 ? "Moderate Risk" :
                       precipitation > 0 ? "Low Risk" : "No Rain";

        const color = status === "High Risk" ? "red" :
                      status === "Moderate Risk" ? "orange" :
                      status === "Low Risk" ? "green" : "blue";

        const marker = L.circleMarker([u.lat, u.lon], {
            color: color,
            fillColor: color,
            fillOpacity: 0.7,
            radius: 8
        }).addTo(map)
          .bindPopup(`<b>${u.name}</b><br>Temp: ${temp}¬∞C<br>Rain: ${precipitation} mm<br>Humidity: ${humidity}%<br>Status: ${status}`);

        if (precipitation >= 0) marker._path.classList.add('blink');
        markers[u.id] = marker;

        table.innerHTML += `
            <tr>
                <td>${u.name}</td>
                <td>${u.lat}</td>
                <td>${u.lon}</td>
                <td>${temp}</td>
                <td>${precipitation}</td>
                <td>${weather}</td>
                <td>${status}</td>
                <td>${time}</td>
                <td>
                    <button class="btn btn-warning btn-alert" onclick="sendAlert(${u.id}, '${u.name}')">
                        <i class="fa fa-bell"></i> Alert
                    </button>
                </td>
            </tr>
        `;
    }

    // Fit map to all markers
    const group = new L.featureGroup(Object.values(markers));
    if (Object.keys(markers).length > 0) map.fitBounds(group.getBounds().pad(0.2));
}

function sendAlert(userId, name) {
    fetch(`/send_alert/${userId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: "Please take precautionary measures." })
    })
    .then(res => res.json())
    .then(data => alert(`üö® ${data.status === 'success' ? 'Alert sent to '+name : 'Failed to send alert!'}`))
    .catch(err => alert("‚ùå Network error: " + err));
}

loadWeather();
setInterval(loadWeather, 60000);
</script>

</body>
</html>
