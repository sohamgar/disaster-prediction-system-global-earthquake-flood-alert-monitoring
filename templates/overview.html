<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Historical Disaster Events</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: "Poppins", sans-serif;
  background: linear-gradient(135deg, #0f172a, #1e293b);
  color: #fff;
  padding: 20px;
}

h2 {
  font-weight: 600;
  padding: 15px 20px;
  background: rgba(0,0,0,0.6);
  border-radius: 15px;
  display: inline-block;
}

.card-glass {
  background: rgba(255,255,255,0.08);
  backdrop-filter: blur(12px);
  border-radius: 20px;
  padding: 20px;
  margin-bottom: 30px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.37);
}

#floodMap, #quakeMap {
  height: 450px;
  border-radius: 20px;
}

.table-container {
  max-height: 350px;
  overflow-y: auto;
  border-radius: 15px;
}

.table {
  background: rgba(255,255,255,0.15);
  color: #000;
}

.table th {
  background: rgba(0,0,0,0.7);
  color: #fff;
  position: sticky;
  top: 0;
}

.chart-container {
  background: rgba(255,255,255,0.08);
  border-radius: 20px;
  padding: 20px;
  margin-top: 20px;
}
</style>
</head>

<body>
<div class="container text-center">

<h2>üåç Historical Disaster Events</h2>

<div class="my-3">
  <a href="/admin/dashboard" class="btn btn-primary btn-lg">Dashboard</a>
</div>

<!-- ================= FLOODS ================= -->
<div class="card-glass">
  <h4>üåä Historical Flood Locations</h4>
  <div id="floodMap"></div>
</div>

<div class="card-glass">
  <h4>Flood Event Details</h4>
  <div class="table-container">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Date</th>
          <th>Area</th>
          <th>Lat</th>
          <th>Lon</th>
          <th>Severity</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody id="floodTable"></tbody>
    </table>
  </div>
</div>

<div class="chart-container">
  <h4>Flood Severity Distribution</h4>
  <canvas id="floodChart"></canvas>
</div>

<hr class="my-5">

<!-- ================= EARTHQUAKES ================= -->
<div class="card-glass">
  <h4>üåã Historical Earthquake Locations</h4>
  <div id="quakeMap"></div>
</div>

<div class="card-glass">
  <h4>Earthquake Event Details</h4>
  <div class="table-container">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Date</th>
          <th>Place</th>
          <th>Lat</th>
          <th>Lon</th>
          <th>Magnitude</th>
          <th>Depth (km)</th>
        </tr>
      </thead>
      <tbody id="quakeTable"></tbody>
    </table>
  </div>
</div>

<div class="chart-container">
  <h4>Earthquake Magnitude Distribution</h4>
  <canvas id="quakeChart"></canvas>
</div>

</div>

<script>
// ================= FLOOD MAP =================
const floodMap = L.map('floodMap').setView([20, 78], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(floodMap);

// ================= EARTHQUAKE MAP =================
const quakeMap = L.map('quakeMap').setView([20, 78], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(quakeMap);

// ================= LOAD FLOODS =================
async function loadFloods() {
  const res = await fetch("/api/get_historical_floods");
  const data = await res.json();

  // Normalize keys to avoid undefined
  let severity = { High:0, Medium:0, Low:0 };

  data.forEach(f => {
    const lat = parseFloat(f.latitude) || 0;
    const lon = parseFloat(f.longitude) || 0;
    const sev = (f.severity || "").trim().toLowerCase();

    // Map string to normalized keys
    let key = "Low";
    if (sev === "high") key = "High";
    else if (sev === "medium") key = "Medium";

    document.getElementById("floodTable").innerHTML += `
      <tr>
        <td>${f.date}</td>
        <td>${f.area}</td>
        <td>${lat}</td>
        <td>${lon}</td>
        <td>${key}</td>
        <td>${f.description}</td>
      </tr>`;

    L.circleMarker([lat, lon], {
      radius: 6,
      color: key === "High" ? "red" : key === "Medium" ? "orange" : "blue",
      fillOpacity: 0.7
    }).addTo(floodMap);

    severity[key]++;
  });

  new Chart(document.getElementById("floodChart"), {
    type: "bar",
    data: {
      labels: ["High","Medium","Low"],
      datasets: [{
        data: [severity.High, severity.Medium, severity.Low],
        backgroundColor: ["red","orange","blue"]
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.15)' } },
        x: { ticks: { color: '#fff' }, grid: { display: false } }
      }
    }
  });
}

// ================= LOAD EARTHQUAKES =================
async function loadEarthquakes() {
  const res = await fetch("/api/get_historical_earthquakes");
  const data = await res.json();

  let magBuckets = { "2-4":0, "4-6":0, "6+":0 };

  data.forEach(q => {
    const lat = parseFloat(q.latitude) || 0;
    const lon = parseFloat(q.longitude) || 0;
    const mag = parseFloat(q.mag) || 0;
    const depth = parseFloat(q.depth) || 0;
    const time = new Date(q.time).toLocaleString();

    document.getElementById("quakeTable").innerHTML += `
      <tr>
        <td>${time}</td>
        <td>${q.place}</td>
        <td>${lat}</td>
        <td>${lon}</td>
        <td>${mag}</td>
        <td>${depth}</td>
      </tr>`;

    L.circleMarker([lat, lon], {
      radius: Math.max(4, mag * 2),
      color: mag >= 6 ? "red" : mag >= 4 ? "orange" : "blue",
      fillOpacity: 0.7
    }).addTo(quakeMap);

    if (mag < 4) magBuckets["2-4"]++;
    else if (mag < 6) magBuckets["4-6"]++;
    else magBuckets["6+"]++;
  });

  new Chart(document.getElementById("quakeChart"), {
    type: "bar",
    data: {
      labels: ["2‚Äì4","4‚Äì6","6+"],
      datasets: [{
        data: [magBuckets["2-4"], magBuckets["4-6"], magBuckets["6+"]],
        backgroundColor: ["#4da6ff","#ff9933","#ff3333"]
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        title: { display: true, text: 'Earthquake Magnitude Distribution', color: '#fff' }
      },
      scales: {
        y: { beginAtZero: true, ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.15)' } },
        x: { ticks: { color: '#fff' }, grid: { display: false } }
      }
    }
  });
}

// Load all data
loadFloods();
loadEarthquakes();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
