<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Feedback</title>

<!-- Bootstrap & FontAwesome -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
/* ----- BODY & BACKGROUND ----- */
body {
    font-family: 'Poppins', sans-serif;
    background: radial-gradient(circle at top, #1a2b4f, #060b18 85%);
    color: #e6e6e6;
    padding: 40px;
}

/* ----- BACK BUTTON ----- */
.back-btn {
    position: absolute;
    top: 25px;
    left: 25px;
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.35);
    color: #fff;
    padding: 8px 16px;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.2s;
    text-decoration: none;
}
.back-btn:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-2px);
    box-shadow: 0 0 12px rgba(255,255,255,0.3);
}

/* ----- HEADINGS ----- */
h2 {
    text-align: center;
    font-weight: 800;
    margin-bottom: 40px;
    color: #fff;
    text-shadow: 0 0 15px rgba(0,0,0,0.3);
}

/* ----- GLASS CARDS ----- */
.glass-card {
    backdrop-filter: blur(20px) saturate(180%);
    background: rgba(255,255,255,0.05);
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.25);
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.5);
    transition: transform 0.2s, box-shadow 0.2s;
}
.glass-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(0,0,0,0.7);
}

/* ----- FORMS ----- */
.form-control, .form-select {
    background: rgba(255,255,255,0.15)!important;
    color: #fff!important;
    border: 1px solid rgba(255,255,255,0.35)!important;
    font-weight: 500;
    border-radius: 12px;
}

.form-select option {
    color: #000;
}

button.btn-success {
    background: linear-gradient(135deg, #2b65ff, #1a45d8);
    border: none;
    padding: 10px 20px;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.2s;
}
button.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 0 15px rgba(50,120,255,0.8);
}

/* ----- TABLE ----- */
.table {
    color: #fff;
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    overflow: hidden;
    backdrop-filter: blur(12px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.4);
}

.table th, .table td {
    text-align: center;
    vertical-align: middle;
}

.table thead tr {
    background: rgba(255,255,255,0.15);
    font-weight: 600;
}

.table tbody tr {
    background: rgba(255,255,255,0.08);
    transition: all 0.25s ease-in-out;
}
.table tbody tr:hover {
    background: rgba(255,255,255,0.18);
    transform: scale(1.002);
}

/* ----- REPLY BOX ----- */
.reply-box {
    background: rgba(255,255,255,0.15);
    padding: 8px 12px;
    border-radius: 12px;
    margin-top: 6px;
    font-size: 0.9rem;
}

/* ----- DELETE BUTTON ----- */
.btn-delete {
    background: linear-gradient(135deg,#ff4b5c,#d81a45);
    color: #fff;
    border: none;
    border-radius: 10px;
    padding: 5px 12px;
    transition: all 0.2s;
}
.btn-delete:hover {
    transform: translateY(-2px);
    box-shadow: 0 0 12px rgba(255,75,92,0.8);
}

/* ----- NAV TABS ----- */
.nav-tabs .nav-link.active {
    background: rgba(255,255,255,0.12);
    color: #fff;
    font-weight: 600;
}

.nav-tabs .nav-link {
    color: #e6e6e6;
    font-weight: 500;
}

.nav-tabs .nav-link:hover {
    color: #fff;
}
</style>
</head>

<body>

<!-- BACK BUTTON -->
<a href="/" class="back-btn">
    <i class="fa fa-arrow-left"></i> Back
</a>

<h2>User Feedback</h2>

<ul class="nav nav-tabs mb-3">
  <li class="nav-item">
    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#earthquake">Earthquake</button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#flood">Flood</button>
  </li>
</ul>

<div class="tab-content">

<!-- EARTHQUAKE -->
<div class="tab-pane fade show active" id="earthquake">
    <div class="glass-card">
        <h5>Submit Earthquake Feedback</h5>
        <form class="feedbackForm">
            <select class="form-select feedbackType mb-3" required>
                 <option value="" selected>Select type</option>
                <option>Complaint</option>
                <option>Query</option>
                <option>System Issue</option>
            </select>
            <textarea class="form-control feedbackMessage mb-3" rows="3" placeholder="Enter message" required></textarea>
            <button class="btn btn-success">Submit</button>
        </form>
    </div>

    <div class="glass-card">
        <h5>Your Earthquake Feedback</h5>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Type</th>
                    <th>Message & Admin Reply</th>
                    <th>Date</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="earthquakeTable"></tbody>
        </table>
    </div>
</div>

<!-- FLOOD -->
<div class="tab-pane fade" id="flood">
    <div class="glass-card">
        <h5>Submit Flood Feedback</h5>
        <form class="feedbackForm">
            <select class="form-select feedbackType mb-3" required>
                 <option value="" selected>Select type</option>
                <option>Complaint</option>
                <option>Query</option>
                <option>System Issue</option>
            </select>
            <textarea class="form-control feedbackMessage mb-3" rows="3" placeholder="Enter message" required></textarea>
            <button class="btn btn-success">Submit</button>
        </form>
    </div>

    <div class="glass-card">
        <h5>Your Flood Feedback</h5>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Type</th>
                    <th>Message & Admin Reply</th>
                    <th>Date</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="floodTable"></tbody>
        </table>
    </div>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const earthquakeTable = document.getElementById("earthquakeTable");
const floodTable = document.getElementById("floodTable");

/* ============================
   LOAD FEEDBACK
============================ */
async function loadFeedback() {
    const res = await fetch("/api/feedback");
    const data = await res.json();

    earthquakeTable.innerHTML = "";
    floodTable.innerHTML = "";

    data.forEach(f => {
let replies = "";

if (f.replies?.length) {
    f.replies.forEach(r => {
        replies += `
            <div class="reply-box">
                <b>${r.admin_username || "Admin"}:</b> ${r.message}
                <br><small class="text-muted">${r.date}</small>
            </div>
        `;
    });
} else {
    replies = `<div class="reply-box text-muted">No reply yet</div>`;
}


        const row = `
            <tr>
                <td>${f.id}</td>
                <td>${f.type}</td>
                <td>${f.message}${replies}</td>
                <td>${f.date}</td>
                <td>
                    <button class="btn-delete" onclick="deleteFeedback(${f.id})">
                        <i class="fa fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;

        if (f.disaster_type === "Earthquake") earthquakeTable.insertAdjacentHTML("beforeend", row);
        if (f.disaster_type === "Flood") floodTable.insertAdjacentHTML("beforeend", row);
    });
}

/* ============================
   FORM SUBMIT (FIXED)
============================ */
document.querySelectorAll(".feedbackForm").forEach(form => {
    form.addEventListener("submit", async e => {
        e.preventDefault();

        const typeSelect = form.querySelector(".feedbackType");
        const messageInput = form.querySelector(".feedbackMessage");

        /* ðŸ”¥ HARD VALIDATION */
        if (typeSelect.value === "") {
            alert("Please select feedback type");
            typeSelect.focus();
            return;
        }

        if (!messageInput.value.trim()) {
            alert("Please enter feedback message");
            messageInput.focus();
            return;
        }

        const tabPane = form.closest(".tab-pane");
        const disaster_type =
            tabPane?.id === "earthquake"
                ? "Earthquake"
                : tabPane?.id === "flood"
                ? "Flood"
                : null;

        if (!disaster_type) {
            alert("Please select Earthquake or Flood tab.");
            return;
        }

        const res = await fetch("/api/feedback/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                type: typeSelect.value,
                message: messageInput.value.trim(),
                disaster_type
            })
        });

        if (res.ok) {
            form.reset();
            loadFeedback();
            alert("Feedback submitted successfully!");
        } else {
            alert("Error submitting feedback.");
        }
    });
});

/* ============================
   DELETE
============================ */
async function deleteFeedback(id) {
    if (!confirm("Are you sure to delete this feedback?")) return;
    const res = await fetch(`/api/feedback/delete/${id}`, { method: "POST" });
    if (res.ok) loadFeedback();
}

/* ============================
   INIT
============================ */
loadFeedback();
</script>

</body>
</html>
