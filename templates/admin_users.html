<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin â€“ Users List</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(135deg, #0a1525, #0f1f3a, #0c1b30);
  min-height: 100vh;
  padding: 40px 20px;
  color: #e0e6f0;
}

h1 {
  text-align: center;
  margin-bottom: 20px;
  font-size: 2.4rem;
  font-weight: 700;
  color: #ffffff;
  text-shadow: 0 2px 6px rgba(0,0,0,0.6);
}

.top-btn, .add-btn {
  display: inline-block;
  color: #ffffff;
  font-weight: 500;
  padding: 10px 18px;
  border-radius: 12px;
  text-decoration: none;
  margin-bottom: 25px;
  transition: all 0.3s ease;
  box-shadow: 0 4px 20px rgba(0,0,0,0.6);
}

.top-btn { background: #14284a; }
.top-btn:hover { background: #0c1f3d; transform: translateY(-2px); }

.add-btn { background: #28a745; }
.add-btn:hover { background: #218838; transform: translateY(-2px); }

/* Flash messages */
.alert {
  position: fixed;
  top: 120px;
  left: 50%;
  transform: translateX(-50%);
  width: 400px;
  max-width: 90%;
  text-align: center;
  border-radius: 12px;
  border: none;
  backdrop-filter: blur(8px);
  z-index: 1050;
}

/* Search Bar */
.search-container {
  text-align: right;
  margin-bottom: 15px;
}
.search-container input {
  width: 250px;
  padding: 8px 12px;
  border-radius: 12px;
  border: 1px solid #0c1f3d;
  backdrop-filter: blur(6px);
  background: rgba(0,0,0,0.5);
  color: #ffffff;
  transition: all 0.3s ease;
}
.search-container input:focus {
  outline: none;
  background: rgba(0,0,0,0.7);
  color: #ffffff;
}

/* Glass Table Wrapper */
.table-wrapper {
  max-height: 650px;
  overflow-y: auto;
  border-radius: 20px;
  box-shadow: 0 12px 35px rgba(0,0,0,0.7);
  backdrop-filter: blur(20px);
  background: rgba(0,20,40,0.6);
  padding: 25px;
  border: 1px solid #0c1f3d;
}

/* Table Styling */
table {
  width: 100%;
  border-collapse: collapse;
}

thead th, tbody td {
  border: 1px solid rgba(255,255,255,0.3);
  padding: 12px 18px;
  text-align: center;
}

thead th {
  position: sticky;
  top: 0;
  background: #0a2e5a;
  color: #ffffff;
  text-transform: uppercase;
  font-weight: 600;
  cursor: pointer;
  z-index: 2;
}

tbody td {
  color: #e0e6f0;
  transition: all 0.3s ease;
}

tbody tr:nth-child(even) { background: rgba(255,255,255,0.05); }
tbody tr:nth-child(odd) { background: rgba(0,0,0,0.0); }
tbody tr:hover { background: rgba(0,50,100,0.4); box-shadow: 0 0 10px rgba(0,120,255,0.5); }

/* Action Buttons */
.btn-action {
  padding: 6px 16px;
  border-radius: 8px;
  text-decoration: none;
  font-size: 0.85rem;
  font-weight: 600;
  transition: all 0.25s ease;
  display: inline-block;
  text-align: center;
  color: #fff;
  border: 1px solid transparent;
  box-shadow: 0 2px 6px rgba(0,0,0,0.5);
}
.view { background: #007bff; border:1px solid #0056b3;}
.view:hover { background: #0056b3; box-shadow: 0 0 10px #007bff;}
.edit { background: #ffc107; color:#000; border:1px solid #e6b800;}
.edit:hover { background: #e6b800; box-shadow: 0 0 10px #ffc107;}
.delete { background: #dc3545; border:1px solid #a71d2a;}
.delete:hover { background: #a71d2a; box-shadow: 0 0 10px #dc3545; }

/* Pagination */
.pagination-wrapper { margin-top: 20px; text-align: center; }
.pagination-wrapper button {
  margin: 0 4px;
  padding: 6px 12px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  background: #0a2e5a;
  color: #ffffff;
  transition: all 0.3s ease;
}
.pagination-wrapper button.active,
.pagination-wrapper button:hover { background: #007bff; color: #fff; box-shadow: 0 0 10px #007bff; }

/* Modal Styling - make it more visible */
.modal-content {
  background-color: #0f203a; /* darker solid background */
  color: #fff;
  border-radius: 15px;
  padding: 20px;
  box-shadow: 0 12px 35px rgba(0,0,0,0.7);
  border: 1px solid #14284a;
}

.modal-header, .modal-footer {
  border: none;
}

.modal-header .btn-close {
  filter: invert(1); /* close button visible on dark modal */
}

/* Responsive */
@media (max-width: 992px) { table { min-width: 700px; } }
@media (max-width: 768px) {
  h1 { font-size: 2rem; }
  .top-btn, .add-btn { padding: 8px 14px; font-size: 0.9rem; }
}
</style>
</head>
<body>

<h1>ðŸ‘¥ User Management</h1>
<a href="/admin/dashboard" class="top-btn"><i class="fa fa-arrow-left me-1"></i> Back to Dashboard</a>
<button class="add-btn" data-bs-toggle="modal" data-bs-target="#addUserModal"><i class="fa fa-plus me-1"></i>Add User</button>

<!-- FLASH MESSAGES -->
<div>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

<div class="search-container">
  <input type="text" id="searchInput" placeholder="Search users...">
</div>

<div class="table-wrapper">
  <table id="userTable" class="table table-borderless">
    <thead>
      <tr>
        <th onclick="sortTable(0)">ID</th>
        <th onclick="sortTable(1)">Username</th>
        <th onclick="sortTable(2)">Name</th>
        <th onclick="sortTable(3)">Email</th>
        <th onclick="sortTable(4)">Mobile</th>
        <th onclick="sortTable(5)">Latitude</th>
        <th onclick="sortTable(6)">Longitude</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for u in users %}
      <tr>
        <td>{{ u[0] }}</td>
        <td>{{ u[1] }}</td>
        <td>{{ u[2] }}</td>
        <td>{{ u[3] }}</td>
        <td>{{ u[4] }}</td>
        <td>{{ u[5] }}</td>
        <td>{{ u[6] }}</td>
        <td>
          <a href="/admin/user/{{ u[0] }}" class="btn-action view"><i class="fa fa-eye me-1"></i>View</a>
          <a href="/admin/user/edit/{{ u[0] }}" class="btn-action edit"><i class="fa fa-pen me-1"></i>Edit</a>
          <a href="#" class="btn-action delete" onclick="confirmDelete({{ u[0] }})"><i class="fa fa-trash me-1"></i>Delete</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="pagination-wrapper" id="pagination"></div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="addUserForm" method="POST" action="/admin/user/add" class="modal-content needs-validation" novalidate>
      <div class="modal-header">
        <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Username</label>
          <input type="text" class="form-control" name="username" required>
          <div class="invalid-feedback">Please enter a username.</div>
        </div>
        <div class="mb-3">
          <label class="form-label">Name</label>
          <input type="text" class="form-control" name="name" required>
          <div class="invalid-feedback">Please enter the name.</div>
        </div>
        <div class="mb-3">
          <label class="form-label">Email</label>
          <input type="email" class="form-control" name="email" required>
          <div class="invalid-feedback">Please enter a valid email.</div>
        </div>
        <div class="mb-3">
          <label class="form-label">Mobile</label>
          <input type="tel" class="form-control" name="mobile" pattern="[0-9]{10}" required>
          <div class="invalid-feedback">Please enter a 10-digit mobile number.</div>
        </div>
        <div class="mb-3">
          <label class="form-label">Latitude</label>
          <input type="number" step="any" class="form-control" name="latitude" required>
          <div class="invalid-feedback">Please enter latitude.</div>
        </div>
        <div class="mb-3">
          <label class="form-label">Longitude</label>
          <input type="number" step="any" class="form-control" name="longitude" required>
          <div class="invalid-feedback">Please enter longitude.</div>
        </div>
                <div class="mb-3">
          <label class="form-label">Password</label>
          <input type="password" class="form-control" name="password" id="password" required>
          <div class="invalid-feedback">Please enter a password.</div>
        </div>

        <div class="mb-3">
          <label class="form-label">Confirm Password</label>
          <input type="password" class="form-control" id="confirm_password" required>
          <div class="invalid-feedback">Passwords do not match.</div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">Add User</button>
      </div>
    </form>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Auto-close flash messages
setTimeout(() => { document.querySelectorAll('.alert').forEach(a => new bootstrap.Alert(a).close()); }, 4500);

// Search
const searchInput = document.getElementById("searchInput");
searchInput.addEventListener("keyup", function() {
  const filter = this.value.toLowerCase();
  const rows = document.querySelectorAll("#userTable tbody tr");
  rows.forEach(row => { row.style.display = Array.from(row.cells).some(cell => cell.textContent.toLowerCase().includes(filter)) ? "" : "none"; });
});

// Sorting
function sortTable(n) {
  const table = document.getElementById("userTable");
  let switching = true, dir = "asc", switchcount = 0;
  while (switching) {
    switching = false;
    const rows = table.rows;
    for (let i = 1; i < rows.length - 1; i++) {
      let shouldSwitch = false;
      let x = rows[i].getElementsByTagName("TD")[n];
      let y = rows[i+1].getElementsByTagName("TD")[n];
      let xContent = isNaN(x.innerText) ? x.innerText.toLowerCase() : parseFloat(x.innerText);
      let yContent = isNaN(y.innerText) ? y.innerText.toLowerCase() : parseFloat(y.innerText);
      if ((dir === "asc" && xContent > yContent) || (dir === "desc" && xContent < yContent)) { shouldSwitch = true; break; }
    }
    if (shouldSwitch) { rows[i].parentNode.insertBefore(rows[i + 1], rows[i]); switching = true; switchcount++; }
    else if (switchcount === 0 && dir === "asc") { dir = "desc"; switching = true; }
  }
}

// Pagination
const rowsPerPage = 10;
const table = document.getElementById("userTable");
const tbody = table.querySelector("tbody");
const rows = Array.from(tbody.querySelectorAll("tr"));
const pagination = document.getElementById("pagination");
function displayPage(page) {
  rows.forEach((row, i) => row.style.display = (i >= (page-1)*rowsPerPage && i < page*rowsPerPage) ? "" : "none");
  pagination.innerHTML = "";
  const totalPages = Math.ceil(rows.length / rowsPerPage);
  for (let i=1;i<=totalPages;i++){
    const btn=document.createElement("button"); btn.textContent=i;
    if(i===page) btn.classList.add("active");
    btn.addEventListener("click",()=>displayPage(i));
    pagination.appendChild(btn);
  }
}
displayPage(1);

// Delete confirmation
function confirmDelete(userId){
  if(confirm("Are you sure you want to delete this user? This action cannot be undone.")){
    window.location.href=`/admin/user/delete/${userId}`;
  }
}

// Bootstrap form validation
(() => {
  'use strict'
  const forms = document.querySelectorAll('.needs-validation')
  Array.from(forms).forEach(form => {
    form.addEventListener('submit', event => {
      if (!form.checkValidity()) {
        event.preventDefault()
        event.stopPropagation()
      }
      form.classList.add('was-validated')
    }, false)
  })
})();

document.getElementById("addUserForm").addEventListener("submit", function (e) {
  const pwd = document.getElementById("password");
  const cpwd = document.getElementById("confirm_password");

  if (pwd.value !== cpwd.value) {
    cpwd.setCustomValidity("Passwords do not match");
    e.preventDefault();
    e.stopPropagation();
  } else {
    cpwd.setCustomValidity("");
  }
});
</script>

</body>
</html>
